<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Daniel Winkler">
<meta name="dcterms.date" content="2024-01-19">

<title>overview_presentation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="overview_presentation_files/libs/clipboard/clipboard.min.js"></script>
<script src="overview_presentation_files/libs/quarto-html/quarto.js"></script>
<script src="overview_presentation_files/libs/quarto-html/popper.min.js"></script>
<script src="overview_presentation_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="overview_presentation_files/libs/quarto-html/anchor.min.js"></script>
<link href="overview_presentation_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="overview_presentation_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="overview_presentation_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="overview_presentation_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="overview_presentation_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

<link href="overview_presentation_files/libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="overview_presentation_files/libs/pagedtable-1.1/js/pagedtable.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction-to-difference-in-differences-estimation" id="toc-introduction-to-difference-in-differences-estimation" class="nav-link active" data-scroll-target="#introduction-to-difference-in-differences-estimation">Introduction to Difference-in-Differences estimation</a>
  <ul class="collapse">
  <li><a href="#introductory-example" id="toc-introductory-example" class="nav-link" data-scroll-target="#introductory-example">Introductory example</a></li>
  </ul></li>
  <li><a href="#recent-developments-in-the-difference-in-differences-literature" id="toc-recent-developments-in-the-difference-in-differences-literature" class="nav-link" data-scroll-target="#recent-developments-in-the-difference-in-differences-literature">Recent developments in the Difference-in-Differences literature</a></li>
  <li><a href="#inspiration-for-the-project-at-hand" id="toc-inspiration-for-the-project-at-hand" class="nav-link" data-scroll-target="#inspiration-for-the-project-at-hand">Inspiration for the project at hand</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"></h1>
<p class="subtitle lead">BBS 2023/24</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Daniel Winkler </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 19, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="introduction-to-difference-in-differences-estimation" class="level1">
<h1>Introduction to Difference-in-Differences estimation</h1>
<ul>
<li><strong>Goal</strong>: identification of a <em>causal average treatment effect on the treated</em> (ATT)</li>
<li><strong>Canonical Setup</strong>:
<ul>
<li>Two <em>similar</em> units are observed over two periods</li>
<li>One unit receives the treatment between the first and second period while the other does not</li>
</ul></li>
<li><strong>Core assumption</strong>: The outcome of interest would have developed in parallel if neither unit had received treatment (referred to as the “parallel trends assumption”). This assumption allows for constant differences in outcomes between units but not differences in changes of the outcome absent treatment.</li>
</ul>
<p>To express the setup mathematically the <em>potential outcomes</em> framework <span class="citation" data-cites="rubinCausalInferenceUsing2005">(<a href="#ref-rubinCausalInferenceUsing2005" role="doc-biblioref">Rubin 2005</a>)</span> can be used:</p>
<p>Let <span class="math inline">\(Y_{i,t}(0)\)</span> be the outcome of unit <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span> if that unit has not received treatment and equivalently <span class="math inline">\(Y_{i,t}(1)\)</span> be the outcome of the unit given it has received treatment. Then the unit level causal effect of treated is given by:</p>
<p><span class="math display">\[
\tau = Y_{i,t}(1) - Y_{i,t}(0)
\]</span></p>
<p>However, for any combination of <span class="math inline">\(i\)</span> and <span class="math inline">\(t\)</span> only one of those outcomes is observed. Using difference-in-differences estimation we infer the unobserved potential outcome based on the never-treated unit. The estimation can be broken up into several parts:</p>
<ol type="1">
<li>How much has the treated unit (<span class="math inline">\(j\)</span>) actually changed?
<ul>
<li><span class="math inline">\(\delta_{j,1} = Y_{j,1}(1) - Y_{j,0}(0)\)</span> (observed)</li>
</ul></li>
<li>How much would the treated unit have changed if it had not received the treatment?
<ul>
<li><span class="math inline">\(\delta_{j,0} = Y_{j,1}(0) - Y_{j,0}(0)\)</span> (unobserved)</li>
</ul></li>
<li>Using the parallel trends assumption <span class="math inline">\(\delta_{j,0}\)</span> can be inferred using the never treated unit <span class="math inline">\(k\)</span> <span class="math display">\[\begin{align*}
\delta_{j,0} &amp;= \delta_{k,0} = \delta_0 \tag{Parallel trends assumption}\\
&amp;= Y_{k,1}(0) - Y_{k,0}(0) \tag{observed}
  \end{align*}\]</span></li>
</ol>
<p>The difference in differences estimator is then the difference of those changes</p>
<p><span class="math display">\[
\tau_{did} = \left[Y_{j,1}(1) - Y_{j,0}(0)\right] - \left[Y_{k,1}(0) - Y_{k,0}(0)\right]
\]</span></p>
<p>The counterfactual outcome is is identified by assuming the outcomes of the treated and untreated unit would have evolved in parallel had neither of them been treated. Strictly speaking this assumptions allows for an arbitrary absolute difference between the outcomes prior to treatment. However, it can be argued that the assumption of parallel trends becomes less realistic in cases of very large differences since in that case the treated and untreated units are vastly different.</p>
<div class="cell" data-hash="overview_presentation_cache/html/unnamed-chunk-1_edbb09c679b99bd5418901e98c96dea6">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>y_j <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>, <span class="fl">1.8</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>y_j_counter <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>, <span class="fl">1.5</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>y_k <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.7</span>, <span class="fl">1.2</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    x, y_k, </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"l"</span>, </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>),</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">yaxt =</span> <span class="st">"n"</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="st">"Y"</span>, <span class="at">xlab =</span> <span class="st">"Period"</span>, </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">bty=</span> <span class="st">"n"</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side=</span><span class="dv">2</span>, <span class="at">labels =</span> <span class="cn">FALSE</span>, <span class="at">at =</span> <span class="cn">NULL</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side=</span><span class="dv">1</span>, <span class="at">at=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"0"</span>,  <span class="st">"1"</span>))</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, y_j)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>], y_j_counter[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>], <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>), <span class="fu">c</span>(<span class="fl">1.5</span>, <span class="fl">1.8</span>), <span class="at">col =</span> <span class="st">"darkgreen"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">4</span>, <span class="at">col =</span> <span class="st">"gray30"</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fl">1.5</span>, <span class="at">y =</span> <span class="fl">0.6</span>, </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="st">"Parallel pre-treatment"</span>, </span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">cex=</span><span class="fl">1.5</span>, <span class="at">srt =</span> <span class="dv">17</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fl">2.2</span>, <span class="at">y =</span> <span class="fl">1.7</span>, </span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">cex=</span><span class="fl">1.5</span>, <span class="at">col =</span> <span class="st">"gray30"</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fl">2.5</span>, <span class="at">y =</span> <span class="fl">1.3</span>, </span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="st">"Counterfactual"</span>,</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">srt =</span> <span class="dv">17</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fl">2.9</span>, <span class="at">y =</span> <span class="fl">1.6</span>,</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="st">"+Effect"</span>,</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="st">"darkgreen"</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="overview_presentation_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>For statistical inference using observational data the outcomes for treated and untreated units are replaced with their sample averages to identify the ATT. Let <span class="math inline">\(\bar Y_{tr,\cdot}\)</span> denote the sample average of the units recieving treatment in the second period and <span class="math inline">\(\bar Y_{nt,\cdot}\)</span> be the equivalent for untreated units<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p><span class="math display">\[
\hat{\tau}_{did} =\left[\bar Y_{tr,1} - \bar Y_{tr,0}\right] - \left[\bar Y_{nt,1} - \bar Y_{nt,0}\right]
\]</span></p>
<section id="introductory-example" class="level2">
<h2 class="anchored" data-anchor-id="introductory-example">Introductory example</h2>
<p>To illustrate the capabilities of the model consider two similar countries<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> experiencing an economic downturn. Country A is trying to offset the effect on available household income by giving its citizens a “Klimabonus” while country D does nothing. Households in country A still experience a decrease in available household income which leads opposition party F to conclude that government economists are incompetent.</p>
<p>Looking at the difference in differences estimator we conclude that party F is incorrect. The decrease in country A is indeed less severe which leads us to believe the policy was (at least partially) successful (assuming there were no other country specific shocks).</p>
<div class="cell" data-hash="overview_presentation_cache/html/unnamed-chunk-2_b20e396423512208503701fae00cac15">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>n_obs <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>units <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>(n_obs<span class="sc">/</span><span class="dv">2</span>), <span class="at">each =</span> <span class="dv">2</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>unit_fe <span class="ot">&lt;-</span> <span class="fu">runif</span>(n_obs<span class="sc">/</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>period <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), n_obs<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>period_fe <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">10</span>), n_obs<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>treatment <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_obs<span class="sc">/</span><span class="dv">2</span>, <span class="dv">1</span>, <span class="fl">0.5</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="sc">*</span> treatment[units] <span class="sc">*</span> period <span class="sc">+</span> <span class="co"># tau = 5</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    period_fe <span class="sc">+</span> <span class="co"># time fixed effect</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    unit_fe[units] <span class="sc">-</span> <span class="co"># unit fixed effect</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="dv">15</span> <span class="sc">*</span> treatment[units] <span class="sc">+</span> <span class="co"># constant diff treated/untreated</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(n_obs)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> y, </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">treated =</span> treatment[units], </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">period =</span> period, </span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">unit =</span> <span class="fu">as.factor</span>(units))</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>y_j <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(y <span class="sc">~</span> period, data[data<span class="sc">$</span>treated <span class="sc">==</span> <span class="dv">1</span>, ], mean)<span class="sc">$</span>y</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>y_k <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(y <span class="sc">~</span> period, data[data<span class="sc">$</span>treated <span class="sc">==</span> <span class="dv">0</span>, ], mean)<span class="sc">$</span>y</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>delta_y_k <span class="ot">&lt;-</span> <span class="fu">diff</span>(y_k)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>y_k <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    y_k[<span class="dv">1</span>],</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    y_k[<span class="dv">1</span>] <span class="sc">+</span> delta_y_k<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    y_k[<span class="dv">1</span>] <span class="sc">+</span> delta_y_k)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>y_j <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    y_j[<span class="dv">1</span>],</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    y_j[<span class="dv">1</span>] <span class="sc">+</span> delta_y_k<span class="sc">/</span><span class="dv">2</span>, <span class="co"># assumed</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    y_j[<span class="dv">2</span>])</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>y_j_counter <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    y_j[<span class="dv">1</span>], </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    y_j[<span class="dv">1</span>] <span class="sc">+</span> delta_y_k<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    y_j[<span class="dv">1</span>] <span class="sc">+</span> delta_y_k) <span class="co"># assumed</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    x, y_k, </span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"l"</span>, </span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">35</span>),</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="co">#yaxt = "n",</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="st">"Avg. availabe household income"</span>, <span class="at">xlab =</span> <span class="st">"Period"</span>, </span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">bty=</span> <span class="st">"n"</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side=</span><span class="dv">1</span>, <span class="at">at=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"0"</span>,  <span class="st">"1"</span>))</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, y_j)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>], y_j_counter[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>], <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>), <span class="fu">c</span>(y_j[<span class="dv">3</span>], y_j_counter[<span class="dv">3</span>]), <span class="at">col =</span> <span class="st">"darkgreen"</span>)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">4</span>, <span class="at">col =</span> <span class="st">"gray30"</span>)</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="at">x =</span> <span class="fl">1.1</span>, <span class="at">y =</span> <span class="dv">31</span>, <span class="at">labels =</span> <span class="st">"D"</span>, <span class="at">cex=</span><span class="fl">1.5</span>)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="at">x =</span> <span class="fl">1.1</span>, <span class="at">y =</span> <span class="dv">16</span>, <span class="at">labels =</span> <span class="st">"A"</span>, <span class="at">cex=</span><span class="fl">1.5</span>)</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fl">1.5</span>, <span class="at">y =</span> <span class="dv">20</span>, </span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="st">"Parallel pre-treatment"</span>, </span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">cex=</span><span class="fl">1.5</span>, <span class="at">srt =</span> <span class="sc">-</span><span class="dv">10</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fl">2.25</span>, <span class="at">y =</span> <span class="dv">28</span>, </span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="st">"</span><span class="sc">\"</span><span class="st">Klimabonus</span><span class="sc">\"</span><span class="st">"</span>,</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">cex=</span><span class="fl">1.5</span>, <span class="at">col =</span> <span class="st">"gray30"</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fl">2.5</span>, <span class="at">y =</span> <span class="fl">6.8</span>, </span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="st">"Counterfactual"</span>,</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">srt =</span> <span class="sc">-</span><span class="dv">10</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fl">2.90</span>, <span class="at">y =</span> <span class="fl">7.8</span>,</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="st">"+Effect"</span>,</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="st">"darkgreen"</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="overview_presentation_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="768"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">~</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">factor</span>(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        period, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"t: 0"</span>,<span class="st">"t: 1"</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">factor</span>(</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        treated, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"D"</span>, <span class="st">"A"</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        ), </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">"Y"</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">frame.plot =</span> F,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">sep =</span> <span class="st">" in "</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">"Distribution of available household income"</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="overview_presentation_files/figure-html/unnamed-chunk-2-2.png" class="img-fluid" width="768"></p>
</div>
</div>
<p><span class="math inline">\(\hat \tau_{did}\)</span> can be computed in R by first calculating the differences in means over time for treated and untreated units separately and calculating the difference in differences.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>y_bars <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">~</span> treated <span class="sc">+</span> period,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    data, </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    mean</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>delta_ys <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">~</span> period,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    y_bars[<span class="fu">order</span>(y_bars<span class="sc">$</span>period, y_bars<span class="sc">$</span>treated),],</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    diff</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>tau_did <span class="ot">&lt;-</span> delta_ys<span class="sc">$</span>y[<span class="dv">2</span>] <span class="sc">-</span> delta_ys<span class="sc">$</span>y[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><span class="math inline">\(\hat \tau_{did} =\)</span> 5.064.</p>
<p>Typically, a time/unit fixed effects model is used for statistical inference:</p>
<p><span id="eq-fe-did"><span class="math display">\[
y_{i, t} = \tau_{did}\ \mathbb{1}(\text{treated}_{i, t}) + \gamma_t + \alpha_i + \epsilon_{i,t}
\tag{1}\]</span></span></p>
<p>Note that in the estimation shown below the variable “treated” is defined at the unit level. Therefore, <span class="math inline">\(\mathbb{1}(\text{treated}_{i,t}) \equiv \mathbb{1}(\text{treated}_i) \times \mathbb{1}(\text{period = 1})\)</span>.</p>
<p>A linear model with treatment and time dummies identifies <span class="math inline">\(\tau_{did}\)</span> but is less efficient (especially in case of high variance in outcomes between units). Both models can (eventually<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>) be estimated using OLS.</p>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fixest)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pander)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">etable</span>(<span class="fu">list</span>(</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">FE model</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">feols</span>(y <span class="sc">~</span> treated<span class="sc">:</span>period <span class="sc">|</span> unit <span class="sc">+</span> period, data),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">dummy model</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">feols</span>(y <span class="sc">~</span> treated <span class="sc">*</span> period, data)),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">postprocess.df =</span> pandoc.table.return,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="st">"rmarkdown"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">&nbsp;</th>
<th style="text-align: center;">FE model</th>
<th style="text-align: center;">dummy model</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Dependent Var.:</td>
<td style="text-align: center;">y</td>
<td style="text-align: center;">y</td>
</tr>
<tr class="even">
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">treated x period</td>
<td style="text-align: center;">5.064*** (0.1266)</td>
<td style="text-align: center;">5.064*** (0.7296)</td>
</tr>
<tr class="even">
<td style="text-align: center;">Constant</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">29.67*** (0.3648)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">treated</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">-14.56*** (0.5159)</td>
</tr>
<tr class="even">
<td style="text-align: center;">period</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">-10.03*** (0.5159)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Fixed-Effects:</td>
<td style="text-align: center;">—————–</td>
<td style="text-align: center;">——————</td>
</tr>
<tr class="even">
<td style="text-align: center;">unit</td>
<td style="text-align: center;">Yes</td>
<td style="text-align: center;">No</td>
</tr>
<tr class="odd">
<td style="text-align: center;">period</td>
<td style="text-align: center;">Yes</td>
<td style="text-align: center;">No</td>
</tr>
<tr class="even">
<td style="text-align: center;">________________</td>
<td style="text-align: center;">_________________</td>
<td style="text-align: center;">__________________</td>
</tr>
<tr class="odd">
<td style="text-align: center;">S.E. type</td>
<td style="text-align: center;">by: unit</td>
<td style="text-align: center;">IID</td>
</tr>
<tr class="even">
<td style="text-align: center;">Observations</td>
<td style="text-align: center;">1,000</td>
<td style="text-align: center;">1,000</td>
</tr>
<tr class="odd">
<td style="text-align: center;">R2</td>
<td style="text-align: center;">0.99413</td>
<td style="text-align: center;">0.61016</td>
</tr>
<tr class="even">
<td style="text-align: center;">Within R2</td>
<td style="text-align: center;">0.76267</td>
<td style="text-align: center;">–</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="recent-developments-in-the-difference-in-differences-literature" class="level1">
<h1>Recent developments in the Difference-in-Differences literature</h1>
<p>Recent literature <span class="citation" data-cites="goodman-baconDifferenceindifferencesVariationTreatment2021c sunEstimatingDynamicTreatment2021a callawayDifferenceinDifferencesMultipleTime2021a">(e.g., <a href="#ref-goodman-baconDifferenceindifferencesVariationTreatment2021c" role="doc-biblioref">Goodman-Bacon 2021</a>; <a href="#ref-sunEstimatingDynamicTreatment2021a" role="doc-biblioref">Sun and Abraham 2021</a>; <a href="#ref-callawayDifferenceinDifferencesMultipleTime2021a" role="doc-biblioref">Callaway and Sant’Anna 2021</a>)</span> has focused on the case in which multiple time periods are observed and different units receive an absorbing treatment in different periods (referred to as “staggard adoption”). This case is illustrated in the graph below:</p>
<div class="cell" data-hash="overview_presentation_cache/html/unnamed-chunk-5_7d122ce2355c6a940b7922155ea077c1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>did_data_staggered <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="st">"https://raw.githubusercontent.com/WU-RDS/RMA2022/main/data/did_data_staggered.csv"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>did_data_staggered<span class="sc">$</span>song_id <span class="ot">&lt;-</span> <span class="fu">as.character</span>(did_data_staggered<span class="sc">$</span>song_id)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>did_data_staggered<span class="sc">$</span>week <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(did_data_staggered<span class="sc">$</span>week)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>did_data_staggered<span class="sc">$</span>week_num <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">factor</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        did_data_staggered<span class="sc">$</span>week, </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(did_data_staggered<span class="sc">$</span>week)), </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(did_data_staggered<span class="sc">$</span>week))))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># data preparation</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>treated_ids <span class="ot">&lt;-</span> <span class="fu">unique</span>(did_data_staggered[did_data_staggered<span class="sc">$</span>treated <span class="sc">==</span> <span class="dv">1</span>, ]<span class="sc">$</span>song_id)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>untreated_ids <span class="ot">&lt;-</span> <span class="fu">unique</span>(did_data_staggered[did_data_staggered<span class="sc">$</span>treated <span class="sc">==</span> <span class="dv">0</span>, ]<span class="sc">$</span>song_id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="overview_presentation_cache/html/unnamed-chunk-6_3b029a8cf13e1840278ca8787e1b08d8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(panelView)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect data</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">panelview</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    streams <span class="sc">~</span> treated_post, </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> did_data_staggered[</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        did_data_staggered<span class="sc">$</span>song_id <span class="sc">%in%</span> <span class="fu">c</span>(</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sample</span>(treated_ids,<span class="dv">5</span>), </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sample</span>(untreated_ids, <span class="dv">3</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">&amp;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        did_data_staggered<span class="sc">$</span>week_num <span class="sc">&gt;</span> <span class="dv">10</span> <span class="sc">&amp;</span> </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        did_data_staggered<span class="sc">$</span>week_num <span class="sc">&lt;=</span> <span class="dv">30</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    , ], </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"song_id"</span>, <span class="st">"week"</span>), </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="st">"unit"</span>,</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre.post =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">by.timing =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">theme.bw =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.adjust =</span> <span class="cn">TRUE</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="overview_presentation_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>In this case it would still seem reasonable to estimate <a href="#eq-fe-did">Equation&nbsp;1</a> where <span class="math inline">\(\mathbb{1}(\text{treated}_{i,t})\)</span> now becomes <span class="math inline">\(1\)</span> at different times for different units. However, <span class="citation" data-cites="goodman-baconDifferenceindifferencesVariationTreatment2021c">Goodman-Bacon (<a href="#ref-goodman-baconDifferenceindifferencesVariationTreatment2021c" role="doc-biblioref">2021</a>)</span> demonstrates that varying treatment timing leads to biased estimates if treatment effects are time-varying due to the fact that already treated units act as controls for later treated units. His difference-in-differences decomposition theorem shows that one essentially estimates a weighted average of multiple canonical difference-in-differences models (as shown above) comparing all treatment adoption groups with each other as well as with never treated units. It can be used to show how much weight is given to the comparisons of different groups.</p>
<div class="cell" data-hash="overview_presentation_cache/html/unnamed-chunk-7_3e411e33ca7bc1097f15f96c188e1453">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bacondecomp)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bacon</span>(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    streams <span class="sc">~</span> treated_post,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">unique</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        did_data_staggered[, </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">c</span>(<span class="st">"streams"</span>, <span class="st">"week"</span>, <span class="st">"song_id"</span>, <span class="st">"treated_post"</span>)]</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_var =</span> <span class="st">"song_id"</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_var =</span> <span class="st">"week"</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    )[, <span class="fu">c</span>(<span class="st">"type"</span>, <span class="st">"weight"</span>, <span class="st">"estimate"</span>, <span class="st">"treated"</span>, <span class="st">"untreated"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false"> <div class="table-caption"><p>Difference-in-Differences decomposition</p></div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["type"],"name":[1],"type":["chr"],"align":["left"]},{"label":["weight"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["estimate"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["treated"],"name":[4],"type":["date"],"align":["right"]},{"label":["untreated"],"name":[5],"type":["date"],"align":["right"]}],"data":[{"1":"Later vs Earlier Treated","2":"8.303272e-04","3":"6935.644444","4":"2017-11-20","5":"2017-09-25","_rn_":"3"},{"1":"Earlier vs Later Treated","2":"1.037909e-04","3":"9689.733333","4":"2017-09-18","5":"2017-09-25","_rn_":"4"},{"1":"Later vs Earlier Treated","2":"5.812291e-04","3":"6541.468254","4":"2017-11-27","5":"2017-09-25","_rn_":"5"},{"1":"Later vs Earlier Treated","2":"5.166481e-04","3":"6272.406250","4":"2017-11-13","5":"2017-09-25","_rn_":"6"},{"1":"Earlier vs Later Treated","2":"1.291620e-04","3":"3427.642857","4":"2017-09-11","5":"2017-09-25","_rn_":"7"},{"1":"Later vs Earlier Treated","2":"1.937430e-04","3":"7488.369048","4":"2017-10-09","5":"2017-09-25","_rn_":"8"},{"1":"Later vs Earlier Treated","2":"2.075818e-04","3":"10073.722222","4":"2017-10-30","5":"2017-09-25","_rn_":"9"},{"1":"Later vs Earlier Treated","2":"2.998404e-04","3":"6976.146154","4":"2017-12-04","5":"2017-09-25","_rn_":"10"},{"1":"Later vs Earlier Treated","2":"5.074222e-05","3":"10527.181818","4":"2017-10-02","5":"2017-09-25","_rn_":"11"},{"1":"Later vs Earlier Treated","2":"1.383879e-04","3":"8462.333333","4":"2017-10-16","5":"2017-09-25","_rn_":"12"},{"1":"Treated vs Untreated","2":"5.007796e-02","3":"1857.287629","4":"2017-09-25","5":"Inf","_rn_":"13"},{"1":"Treated vs Untreated","2":"1.469679e-01","3":"2391.548352","4":"2017-11-20","5":"Inf","_rn_":"15"},{"1":"Treated vs Untreated","2":"1.469679e-01","3":"12180.023399","4":"2017-09-18","5":"Inf","_rn_":"16"},{"1":"Treated vs Untreated","2":"9.525699e-02","3":"2382.490557","4":"2017-11-27","5":"Inf","_rn_":"17"},{"1":"Treated vs Untreated","2":"1.001559e-01","3":"1288.838914","4":"2017-11-13","5":"Inf","_rn_":"18"},{"1":"Treated vs Untreated","2":"9.525699e-02","3":"-1572.563487","4":"2017-09-11","5":"Inf","_rn_":"19"},{"1":"Treated vs Untreated","2":"1.028775e-01","3":"4051.778652","4":"2017-10-09","5":"Inf","_rn_":"20"},{"1":"Treated vs Untreated","2":"5.143877e-02","3":"5223.743476","4":"2017-10-30","5":"Inf","_rn_":"21"},{"1":"Treated vs Untreated","2":"4.599552e-02","3":"2380.711213","4":"2017-12-04","5":"Inf","_rn_":"22"},{"1":"Treated vs Untreated","2":"5.089445e-02","3":"8169.942309","4":"2017-10-02","5":"Inf","_rn_":"23"},{"1":"Treated vs Untreated","2":"5.171094e-02","3":"2360.395763","4":"2017-10-16","5":"Inf","_rn_":"24"},{"1":"Earlier vs Later Treated","2":"8.856824e-04","3":"4714.020833","4":"2017-09-25","5":"2017-11-20","_rn_":"25"},{"1":"Earlier vs Later Treated","2":"2.802354e-03","3":"11478.933333","4":"2017-09-18","5":"2017-11-20","_rn_":"28"},{"1":"Later vs Earlier Treated","2":"1.937430e-04","3":"4655.880952","4":"2017-11-27","5":"2017-11-20","_rn_":"29"},{"1":"Earlier vs Later Treated","2":"3.182921e-04","3":"4735.884058","4":"2017-11-13","5":"2017-11-20","_rn_":"30"},{"1":"Earlier vs Later Treated","2":"1.937430e-03","3":"-3.883333","4":"2017-09-11","5":"2017-11-20","_rn_":"31"},{"1":"Earlier vs Later Treated","2":"1.494589e-03","3":"8186.083333","4":"2017-10-09","5":"2017-11-20","_rn_":"32"},{"1":"Earlier vs Later Treated","2":"4.359218e-04","3":"9268.523810","4":"2017-10-30","5":"2017-11-20","_rn_":"33"},{"1":"Later vs Earlier Treated","2":"1.799042e-04","3":"8877.717949","4":"2017-12-04","5":"2017-11-20","_rn_":"34"},{"1":"Earlier vs Later Treated","2":"8.234078e-04","3":"18217.834734","4":"2017-10-02","5":"2017-11-20","_rn_":"35"},{"1":"Earlier vs Later Treated","2":"6.573424e-04","3":"4721.438596","4":"2017-10-16","5":"2017-11-20","_rn_":"36"},{"1":"Later vs Earlier Treated","2":"1.591461e-04","3":"-663.637681","4":"2017-09-25","5":"2017-09-18","_rn_":"37"},{"1":"Later vs Earlier Treated","2":"2.802354e-03","3":"1528.177778","4":"2017-11-20","5":"2017-09-18","_rn_":"39"},{"1":"Later vs Earlier Treated","2":"1.937430e-03","3":"1017.538095","4":"2017-11-27","5":"2017-09-18","_rn_":"41"},{"1":"Later vs Earlier Treated","2":"1.771365e-03","3":"967.427083","4":"2017-11-13","5":"2017-09-18","_rn_":"42"},{"1":"Earlier vs Later Treated","2":"1.937430e-04","3":"-3950.642857","4":"2017-09-11","5":"2017-09-18","_rn_":"43"},{"1":"Later vs Earlier Treated","2":"8.718436e-04","3":"4255.246032","4":"2017-10-09","5":"2017-09-18","_rn_":"44"},{"1":"Later vs Earlier Treated","2":"7.472945e-04","3":"4325.888889","4":"2017-10-30","5":"2017-09-18","_rn_":"45"},{"1":"Later vs Earlier Treated","2":"9.894733e-04","3":"672.787879","4":"2017-12-04","5":"2017-09-18","_rn_":"46"},{"1":"Later vs Earlier Treated","2":"3.044533e-04","3":"9835.560606","4":"2017-10-02","5":"2017-09-18","_rn_":"47"},{"1":"Later vs Earlier Treated","2":"5.535515e-04","3":"3435.116667","4":"2017-10-16","5":"2017-09-18","_rn_":"48"},{"1":"Earlier vs Later Treated","2":"6.642618e-04","3":"4167.767361","4":"2017-09-25","5":"2017-11-27","_rn_":"49"},{"1":"Earlier vs Later Treated","2":"3.321309e-04","3":"4638.736111","4":"2017-11-20","5":"2017-11-27","_rn_":"51"},{"1":"Earlier vs Later Treated","2":"2.075818e-03","3":"11179.400000","4":"2017-09-18","5":"2017-11-27","_rn_":"52"},{"1":"Earlier vs Later Treated","2":"4.243895e-04","3":"8057.434783","4":"2017-11-13","5":"2017-11-27","_rn_":"54"},{"1":"Earlier vs Later Treated","2":"1.420782e-03","3":"-315.344156","4":"2017-09-11","5":"2017-11-27","_rn_":"55"},{"1":"Earlier vs Later Treated","2":"1.162458e-03","3":"7250.857143","4":"2017-10-09","5":"2017-11-27","_rn_":"56"},{"1":"Earlier vs Later Treated","2":"3.874860e-04","3":"9533.886905","4":"2017-10-30","5":"2017-11-27","_rn_":"57"},{"1":"Later vs Earlier Treated","2":"5.996808e-05","3":"4988.384615","4":"2017-12-04","5":"2017-11-27","_rn_":"58"},{"1":"Earlier vs Later Treated","2":"6.273584e-04","3":"16225.297794","4":"2017-10-02","5":"2017-11-27","_rn_":"59"},{"1":"Earlier vs Later Treated","2":"5.258739e-04","3":"4503.885965","4":"2017-10-16","5":"2017-11-27","_rn_":"60"},{"1":"Earlier vs Later Treated","2":"5.166481e-04","3":"5268.968750","4":"2017-09-25","5":"2017-11-13","_rn_":"61"},{"1":"Later vs Earlier Treated","2":"2.075818e-04","3":"6086.944444","4":"2017-11-20","5":"2017-11-13","_rn_":"63"},{"1":"Earlier vs Later Treated","2":"1.660654e-03","3":"11844.937500","4":"2017-09-18","5":"2017-11-13","_rn_":"64"},{"1":"Later vs Earlier Treated","2":"2.583240e-04","3":"9856.464286","4":"2017-11-27","5":"2017-11-13","_rn_":"65"},{"1":"Earlier vs Later Treated","2":"1.162458e-03","3":"330.817460","4":"2017-09-11","5":"2017-11-13","_rn_":"67"},{"1":"Earlier vs Later Treated","2":"8.303272e-04","3":"9372.455556","4":"2017-10-09","5":"2017-11-13","_rn_":"68"},{"1":"Earlier vs Later Treated","2":"1.937430e-04","3":"10152.690476","4":"2017-10-30","5":"2017-11-13","_rn_":"69"},{"1":"Later vs Earlier Treated","2":"1.799042e-04","3":"10222.884615","4":"2017-12-04","5":"2017-11-13","_rn_":"70"},{"1":"Earlier vs Later Treated","2":"4.705188e-04","3":"20540.799020","4":"2017-10-02","5":"2017-11-13","_rn_":"71"},{"1":"Earlier vs Later Treated","2":"3.505826e-04","3":"5423.375000","4":"2017-10-16","5":"2017-11-13","_rn_":"72"},{"1":"Later vs Earlier Treated","2":"2.121947e-04","3":"7461.891304","4":"2017-09-25","5":"2017-09-11","_rn_":"73"},{"1":"Later vs Earlier Treated","2":"2.075818e-03","3":"5389.527778","4":"2017-11-20","5":"2017-09-11","_rn_":"75"},{"1":"Later vs Earlier Treated","2":"3.321309e-04","3":"10561.319444","4":"2017-09-18","5":"2017-09-11","_rn_":"76"},{"1":"Later vs Earlier Treated","2":"1.420782e-03","3":"5033.584416","4":"2017-11-27","5":"2017-09-11","_rn_":"77"},{"1":"Later vs Earlier Treated","2":"1.328524e-03","3":"4619.295139","4":"2017-11-13","5":"2017-09-11","_rn_":"78"},{"1":"Later vs Earlier Treated","2":"7.749721e-04","3":"7775.744048","4":"2017-10-09","5":"2017-09-11","_rn_":"80"},{"1":"Later vs Earlier Treated","2":"5.812291e-04","3":"8467.583333","4":"2017-10-30","5":"2017-09-11","_rn_":"81"},{"1":"Later vs Earlier Treated","2":"7.196169e-04","3":"5256.358974","4":"2017-12-04","5":"2017-09-11","_rn_":"82"},{"1":"Later vs Earlier Treated","2":"3.044533e-04","3":"13557.068182","4":"2017-10-02","5":"2017-09-11","_rn_":"83"},{"1":"Later vs Earlier Treated","2":"4.612929e-04","3":"6799.050000","4":"2017-10-16","5":"2017-09-11","_rn_":"84"},{"1":"Earlier vs Later Treated","2":"1.476137e-04","3":"4344.937500","4":"2017-09-25","5":"2017-10-09","_rn_":"85"},{"1":"Later vs Earlier Treated","2":"1.245491e-03","3":"8282.588889","4":"2017-11-20","5":"2017-10-09","_rn_":"87"},{"1":"Earlier vs Later Treated","2":"6.227454e-04","3":"11639.855556","4":"2017-09-18","5":"2017-10-09","_rn_":"88"},{"1":"Later vs Earlier Treated","2":"9.041341e-04","3":"7401.035714","4":"2017-11-27","5":"2017-10-09","_rn_":"89"},{"1":"Later vs Earlier Treated","2":"7.380687e-04","3":"8215.806250","4":"2017-11-13","5":"2017-10-09","_rn_":"90"},{"1":"Earlier vs Later Treated","2":"5.166481e-04","3":"754.125000","4":"2017-09-11","5":"2017-10-09","_rn_":"91"},{"1":"Later vs Earlier Treated","2":"2.490982e-04","3":"12603.055556","4":"2017-10-30","5":"2017-10-09","_rn_":"93"},{"1":"Later vs Earlier Treated","2":"4.797446e-04","3":"7690.423077","4":"2017-12-04","5":"2017-10-09","_rn_":"94"},{"1":"Earlier vs Later Treated","2":"7.841980e-05","3":"48737.205882","4":"2017-10-02","5":"2017-10-09","_rn_":"95"},{"1":"Later vs Earlier Treated","2":"9.225858e-05","3":"10009.000000","4":"2017-10-16","5":"2017-10-09","_rn_":"96"},{"1":"Earlier vs Later Treated","2":"1.845172e-04","3":"5169.000000","4":"2017-09-25","5":"2017-10-30","_rn_":"97"},{"1":"Later vs Earlier Treated","2":"3.113727e-04","3":"7363.688889","4":"2017-11-20","5":"2017-10-30","_rn_":"99"},{"1":"Earlier vs Later Treated","2":"6.227454e-04","3":"10906.611111","4":"2017-09-18","5":"2017-10-30","_rn_":"100"},{"1":"Later vs Earlier Treated","2":"2.583240e-04","3":"7823.482143","4":"2017-11-27","5":"2017-10-30","_rn_":"101"},{"1":"Later vs Earlier Treated","2":"1.476137e-04","3":"6737.406250","4":"2017-11-13","5":"2017-10-30","_rn_":"102"},{"1":"Earlier vs Later Treated","2":"4.520671e-04","3":"61.142857","4":"2017-09-11","5":"2017-10-30","_rn_":"103"},{"1":"Earlier vs Later Treated","2":"2.490982e-04","3":"9987.416667","4":"2017-10-09","5":"2017-10-30","_rn_":"104"},{"1":"Later vs Earlier Treated","2":"1.499202e-04","3":"8197.692308","4":"2017-12-04","5":"2017-10-30","_rn_":"106"},{"1":"Earlier vs Later Treated","2":"1.568396e-04","3":"25567.544118","4":"2017-10-02","5":"2017-10-30","_rn_":"107"},{"1":"Earlier vs Later Treated","2":"8.764565e-05","3":"872.947368","4":"2017-10-16","5":"2017-10-30","_rn_":"108"},{"1":"Earlier vs Later Treated","2":"3.690343e-04","3":"4846.237500","4":"2017-09-25","5":"2017-12-04","_rn_":"109"},{"1":"Earlier vs Later Treated","2":"3.321309e-04","3":"8235.819444","4":"2017-11-20","5":"2017-12-04","_rn_":"111"},{"1":"Earlier vs Later Treated","2":"1.141700e-03","3":"11570.654545","4":"2017-09-18","5":"2017-12-04","_rn_":"112"},{"1":"Earlier vs Later Treated","2":"1.153232e-04","3":"4868.020000","4":"2017-11-27","5":"2017-12-04","_rn_":"113"},{"1":"Earlier vs Later Treated","2":"3.182921e-04","3":"7987.760870","4":"2017-11-13","5":"2017-12-04","_rn_":"114"},{"1":"Earlier vs Later Treated","2":"7.749721e-04","3":"212.738095","4":"2017-09-11","5":"2017-12-04","_rn_":"115"},{"1":"Earlier vs Later Treated","2":"6.642618e-04","3":"7770.361111","4":"2017-10-09","5":"2017-12-04","_rn_":"116"},{"1":"Earlier vs Later Treated","2":"2.421788e-04","3":"9589.714286","4":"2017-10-30","5":"2017-12-04","_rn_":"117"},{"1":"Earlier vs Later Treated","2":"3.528891e-04","3":"16034.300654","4":"2017-10-02","5":"2017-12-04","_rn_":"119"},{"1":"Earlier vs Later Treated","2":"3.067598e-04","3":"5419.443609","4":"2017-10-16","5":"2017-12-04","_rn_":"120"},{"1":"Earlier vs Later Treated","2":"3.690343e-05","3":"4082.875000","4":"2017-09-25","5":"2017-10-02","_rn_":"121"},{"1":"Later vs Earlier Treated","2":"7.265363e-04","3":"17251.663492","4":"2017-11-20","5":"2017-10-02","_rn_":"123"},{"1":"Earlier vs Later Treated","2":"2.075818e-04","3":"13621.266667","4":"2017-09-18","5":"2017-10-02","_rn_":"124"},{"1":"Later vs Earlier Treated","2":"5.166481e-04","3":"15418.991071","4":"2017-11-27","5":"2017-10-02","_rn_":"125"},{"1":"Later vs Earlier Treated","2":"4.428412e-04","3":"18334.197917","4":"2017-11-13","5":"2017-10-02","_rn_":"126"},{"1":"Earlier vs Later Treated","2":"1.937430e-04","3":"2980.428571","4":"2017-09-11","5":"2017-10-02","_rn_":"127"},{"1":"Later vs Earlier Treated","2":"9.687151e-05","3":"47178.166667","4":"2017-10-09","5":"2017-10-02","_rn_":"128"},{"1":"Later vs Earlier Treated","2":"1.660654e-04","3":"27046.527778","4":"2017-10-30","5":"2017-10-02","_rn_":"129"},{"1":"Later vs Earlier Treated","2":"2.698564e-04","3":"14932.273504","4":"2017-12-04","5":"2017-10-02","_rn_":"130"},{"1":"Later vs Earlier Treated","2":"9.225858e-05","3":"37586.850000","4":"2017-10-16","5":"2017-10-02","_rn_":"132"},{"1":"Earlier vs Later Treated","2":"1.107103e-04","3":"7056.770833","4":"2017-09-25","5":"2017-10-16","_rn_":"133"},{"1":"Later vs Earlier Treated","2":"5.189545e-04","3":"5661.711111","4":"2017-11-20","5":"2017-10-16","_rn_":"135"},{"1":"Earlier vs Later Treated","2":"4.151636e-04","3":"12895.583333","4":"2017-09-18","5":"2017-10-16","_rn_":"136"},{"1":"Later vs Earlier Treated","2":"3.874860e-04","3":"5581.690476","4":"2017-11-27","5":"2017-10-16","_rn_":"137"},{"1":"Later vs Earlier Treated","2":"2.952275e-04","3":"5040.093750","4":"2017-11-13","5":"2017-10-16","_rn_":"138"},{"1":"Earlier vs Later Treated","2":"3.229050e-04","3":"1713.371429","4":"2017-09-11","5":"2017-10-16","_rn_":"139"},{"1":"Earlier vs Later Treated","2":"8.303272e-05","3":"11337.305556","4":"2017-10-09","5":"2017-10-16","_rn_":"140"},{"1":"Later vs Earlier Treated","2":"8.303272e-05","3":"3965.722222","4":"2017-10-30","5":"2017-10-16","_rn_":"141"},{"1":"Later vs Earlier Treated","2":"2.098883e-04","3":"6587.747253","4":"2017-12-04","5":"2017-10-16","_rn_":"142"},{"1":"Earlier vs Later Treated","2":"7.841980e-05","3":"40141.705882","4":"2017-10-02","5":"2017-10-16","_rn_":"143"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="inspiration-for-the-project-at-hand" class="level1">
<h1>Inspiration for the project at hand</h1>
<p>To eliminate the above mentioned problem with time-varying adoption/treatment effects, <span class="citation" data-cites="callawayDifferenceinDifferencesMultipleTime2021a">Callaway and Sant’Anna (<a href="#ref-callawayDifferenceinDifferencesMultipleTime2021a" role="doc-biblioref">2021</a>)</span> extend the canonical model and define the group-time average treatment effect<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> <span class="math inline">\(ATT(g,t)\)</span>. A group <span class="math inline">\(g\)</span> is defined as all units receiving treatment at the same time. For each group <span class="math inline">\(g\)</span> and time <span class="math inline">\(t\)</span> a separate average treatment effect is estimated.</p>
<p>A plot of the estimated coefficients for groups adopting treatment in 2004, 2006, and 2007 would look as follows:</p>
<div class="cell" data-hash="overview_presentation_cache/html/unnamed-chunk-8_d94687eef2d0d86b9a6a88b1a4048a62">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(did)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(mpdta)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>attgt_ex <span class="ot">&lt;-</span> <span class="fu">att_gt</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">yname =</span> <span class="st">"lemp"</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">gname =</span> <span class="st">"first.treat"</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">idname =</span> <span class="st">"countyreal"</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">tname =</span> <span class="st">"year"</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">xformla =</span> <span class="sc">~</span><span class="dv">1</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> mpdta,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">est_method =</span> <span class="st">"reg"</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdid</span>(attgt_ex)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="overview_presentation_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>The <span class="math inline">\(ATT(g,t)\)</span> is estimated for both pre- and post-treatment periods. The pre-treatment coefficients not being significantly different from <span class="math inline">\(0\)</span> has been used as evidence for the parallel trends assumption (extrapolating that this would still be the case in the post-treatment periods if the treatment had not happened). It is well known that this is not a good idea <span class="citation" data-cites="altmanStatisticsNotesAbsence1995 wassersteinMovingWorld052019">(<a href="#ref-altmanStatisticsNotesAbsence1995" role="doc-biblioref">Altman and Bland 1995</a>; <a href="#ref-wassersteinMovingWorld052019" role="doc-biblioref">Wasserstein, Schirm, and Lazar 2019</a>)</span>. <span class="citation" data-cites="callawayDifferenceinDifferencesMultipleTime2021a">Callaway and Sant’Anna (<a href="#ref-callawayDifferenceinDifferencesMultipleTime2021a" role="doc-biblioref">2021</a>)</span> provide a p-value for a Wald pre-test of the parallel trend assumption at least eliminating the multiple testing problem.</p>
<div class="cell" data-hash="overview_presentation_cache/html/unnamed-chunk-9_b0d86601ae8a2ce0ce9a3c4c6a97222e">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(attgt_ex)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
att_gt(yname = "lemp", tname = "year", idname = "countyreal", 
    gname = "first.treat", xformla = ~1, data = mpdta, est_method = "reg")

Reference: Callaway, Brantly and Pedro H.C. Sant'Anna.  "Difference-in-Differences with Multiple Time Periods." Journal of Econometrics, Vol. 225, No. 2, pp. 200-230, 2021. &lt;https://doi.org/10.1016/j.jeconom.2020.12.001&gt;, &lt;https://arxiv.org/abs/1803.09015&gt; 

Group-Time Average Treatment Effects:
 Group Time ATT(g,t) Std. Error [95% Simult.  Conf. Band]  
  2004 2004  -0.0105     0.0244       -0.0765      0.0555  
  2004 2005  -0.0704     0.0305       -0.1530      0.0122  
  2004 2006  -0.1373     0.0391       -0.2432     -0.0313 *
  2004 2007  -0.1008     0.0367       -0.2001     -0.0015 *
  2006 2004   0.0065     0.0242       -0.0589      0.0720  
  2006 2005  -0.0028     0.0193       -0.0551      0.0496  
  2006 2006  -0.0046     0.0171       -0.0510      0.0419  
  2006 2007  -0.0412     0.0208       -0.0974      0.0150  
  2007 2004   0.0305     0.0148       -0.0095      0.0705  
  2007 2005  -0.0027     0.0158       -0.0456      0.0401  
  2007 2006  -0.0311     0.0190       -0.0826      0.0204  
  2007 2007  -0.0261     0.0165       -0.0708      0.0187  
---
Signif. codes: `*' confidence band does not cover 0

P-value for pre-test of parallel trends assumption:  0.16812
Control Group:  Never Treated,  Anticipation Periods:  0
Estimation Method:  Outcome Regression</code></pre>
</div>
</div>
<p>In this project I propose a Bayesian estimation framework for the <span class="math inline">\(ATT(g,t)\)</span>. The Bayesian paradigm allows for different treatment of pre- and post-treatment estimation. As we want to show that parameters do not systematically deviate from <span class="math inline">\(0\)</span> (pre-test for parallel trends) in the pre-period the cautious prior choice is a diffuse prior with a random walk law of motion to allow deviations to accumulate over time and naturally handle missing data:</p>
<p><span class="math display">\[\begin{align}
    \tau^{pre}_0 &amp;= \mathcal{N}(0, \sigma^2), \quad \sigma^2 &gt;&gt; 0 \\
    \tau^{pre}_t &amp;= \tau^{pre}_{t-1} + w_t, \quad w_t \sim \mathcal{N}(0, \sigma^2)
\end{align}\]</span></p>
<p>In order to assess whether the trends deviate substantially the researcher can define a “region of practical equivalence” <span class="citation" data-cites="makowskiBayestestRDescribingEffects2019">(“ROPE,” <a href="#ref-makowskiBayestestRDescribingEffects2019" role="doc-biblioref">Makowski, Ben-Shachar, and Lüdecke 2019</a>)</span> around <span class="math inline">\(0\)</span> and easily calculate the posterior probability of being within the ROPE. In addition, if one is uncomfortable with defining a region of equivalence, one can look at the Savage-Dickey density ratio <span class="citation" data-cites="wagenmakersBayesianHypothesisTesting2010a dickeyWeightedLikelihoodRatio1970">(SDR, <a href="#ref-wagenmakersBayesianHypothesisTesting2010a" role="doc-biblioref">Wagenmakers et al. 2010</a>; <a href="#ref-dickeyWeightedLikelihoodRatio1970" role="doc-biblioref">Dickey and Lientz 1970</a>)</span> to see if the data provides additional evidence (over the prior) for the hypothesis of no pre-treatment trend violations (essentially if the posterior density is higher at <span class="math inline">\(0\)</span> than the prior density<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>):</p>
<p><span class="math display">\[
SDR_t = \frac{p(\tau^{pre}_t = 0 | y, \tau^{pre}_{t-1})}{p(\tau^{pre}_t = 0 |  \tau^{pre}_{t-1})}
\]</span></p>
<p>One could then choose <span class="math inline">\(\underset{t \in [0, T^{pre}]}{arg\ max}\ SDR_t\)</span> and see if the post-treatment effect would still hold if there was a similar trend violation (or a multiple thereof) <span class="citation" data-cites="rambachanMoreCredibleApproach2023a">(similar to <a href="#ref-rambachanMoreCredibleApproach2023a" role="doc-biblioref">Rambachan and Roth 2023</a>)</span>.</p>

</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-altmanStatisticsNotesAbsence1995" class="csl-entry" role="listitem">
Altman, Douglas G., and J. Martin Bland. 1995. <span>“Statistics Notes: Absence of Evidence Is Not Evidence of Absence.”</span> <em><span>BMJ</span></em> 311 (7003): 485. <a href="https://doi.org/10.1136/bmj.311.7003.485">https://doi.org/10.1136/bmj.311.7003.485</a>.
</div>
<div id="ref-callawayDifferenceinDifferencesMultipleTime2021a" class="csl-entry" role="listitem">
Callaway, Brantly, and Pedro H. C. Sant’Anna. 2021. <span>“Difference-in-Differences with Multiple Time Periods.”</span> <em>Journal of Econometrics</em>, Themed issue: Treatment effect 1, 225 (2): 200–230. <a href="https://doi.org/10.1016/j.jeconom.2020.12.001">https://doi.org/10.1016/j.jeconom.2020.12.001</a>.
</div>
<div id="ref-cameron2005microeconometrics" class="csl-entry" role="listitem">
Cameron, A Colin, and Pravin K Trivedi. 2005. <em>Microeconometrics: Methods and Applications</em>. Cambridge university press.
</div>
<div id="ref-dickeyWeightedLikelihoodRatio1970" class="csl-entry" role="listitem">
Dickey, James M., and B. P. Lientz. 1970. <span>“The Weighted Likelihood Ratio, Sharp Hypotheses about Chances, the Order of a Markov Chain.”</span> <em>The Annals of Mathematical Statistics</em> 41 (1): 214–26. <a href="https://doi.org/10.1214/aoms/1177697203">https://doi.org/10.1214/aoms/1177697203</a>.
</div>
<div id="ref-goodman-baconDifferenceindifferencesVariationTreatment2021c" class="csl-entry" role="listitem">
Goodman-Bacon, Andrew. 2021. <span>“Difference-in-Differences with Variation in Treatment Timing.”</span> <em>Journal of Econometrics</em>, Themed issue: Treatment effect 1, 225 (2): 254–77. <a href="https://doi.org/10.1016/j.jeconom.2021.03.014">https://doi.org/10.1016/j.jeconom.2021.03.014</a>.
</div>
<div id="ref-makowskiBayestestRDescribingEffects2019" class="csl-entry" role="listitem">
Makowski, Dominique, Mattan S. Ben-Shachar, and Daniel Lüdecke. 2019. <span>“<span class="nocase">bayestestR</span>: Describing Effects and Their Uncertainty, Existence and Significance Within the Bayesian Framework.”</span> <em>Journal of Open Source Software</em> 4 (40): 1541. <a href="https://doi.org/10.21105/joss.01541">https://doi.org/10.21105/joss.01541</a>.
</div>
<div id="ref-rambachanMoreCredibleApproach2023a" class="csl-entry" role="listitem">
Rambachan, Ashesh, and Jonathan Roth. 2023. <span>“A More Credible Approach to Parallel Trends.”</span> <em>Review of Economic Studies</em> 90 (5): 2555–91. <a href="https://doi.org/10.1093/restud/rdad018">https://doi.org/10.1093/restud/rdad018</a>.
</div>
<div id="ref-rubinCausalInferenceUsing2005" class="csl-entry" role="listitem">
Rubin, Donald B. 2005. <span>“Causal Inference Using Potential Outcomes: Design, Modeling, Decisions.”</span> <em>Journal of the American Statistical Association</em> 100 (469): 322–31. <a href="https://www.jstor.org/stable/27590541">https://www.jstor.org/stable/27590541</a>.
</div>
<div id="ref-sunEstimatingDynamicTreatment2021a" class="csl-entry" role="listitem">
Sun, Liyang, and Sarah Abraham. 2021. <span>“Estimating Dynamic Treatment Effects in Event Studies with Heterogeneous Treatment Effects.”</span> <em>Journal of Econometrics</em>, Themed issue: Treatment effect 1, 225 (2): 175–99. <a href="https://doi.org/10.1016/j.jeconom.2020.09.006">https://doi.org/10.1016/j.jeconom.2020.09.006</a>.
</div>
<div id="ref-wagenmakersBayesianHypothesisTesting2010a" class="csl-entry" role="listitem">
Wagenmakers, Eric-Jan, Tom Lodewyckx, Himanshu Kuriyal, and Raoul Grasman. 2010. <span>“Bayesian Hypothesis Testing for Psychologists: A Tutorial on the Savage–Dickey Method.”</span> <em>Cognitive Psychology</em> 60 (3): 158–89. <a href="https://doi.org/10.1016/j.cogpsych.2009.12.001">https://doi.org/10.1016/j.cogpsych.2009.12.001</a>.
</div>
<div id="ref-wassersteinMovingWorld052019" class="csl-entry" role="listitem">
Wasserstein, Ronald L., Allen L. Schirm, and Nicole A. Lazar. 2019. <span>“Moving to a World Beyond <span>‘p <span>&lt;</span> 0.05’</span>.”</span> <em>The American Statistician</em> 73 (March): 1–19. <a href="https://doi.org/10.1080/00031305.2019.1583913">https://doi.org/10.1080/00031305.2019.1583913</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>The indicator whether treatment has been received by a unit is omitted since <span class="math inline">\(\bar Y_{tr,1}\)</span> implies treatment has been received while all other <span class="math inline">\(\bar Y_{\cdot, \cdot}\)</span> imply absence of treatment<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>The scenario is completely fictitious and any similarities to actual countries are purely coincidental.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>See e.g., <span class="citation" data-cites="cameron2005microeconometrics">Cameron and Trivedi (<a href="#ref-cameron2005microeconometrics" role="doc-biblioref">2005, 703f</a>.)</span> for details on estimation of fixed effects models.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Their notation is extremely complicated so I will atempt to present a simplified version<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>This has the caveat that a posterior density based on the MCMC draws has to be estimated.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>